{% extends 'layout-analysis.html' %}
{% load staticfiles %}
{% load jsonify %}

{% block heading %}Submission - Reference Stars{% endblock %}

{% block styles %}
<style>
.header-tooltip {
  color: #96c9f5;
  cursor: help;
}
</style>
{% endblock %}

{% block content-interior %}
<ol class="breadcrumb">
  <li><a href="#">Astrometry</a></li>
  <li><a href="#">Point Sources</a></li>
  <li><a href="#">Reference Stars</a></li>
  <li>Reduction</li>
  <li><a href="#">Light Curve</a></li>
</ol>

<h3>Reduction to Standard Magnitudes</h3>
<p>
Let's convert our raw instrumental magnitudes to standard magnitudes per the following equation:
</p>
<p>
<blockquote>
M<sub>t</sub> = (m<sub>t</sub> - m<sub>c</sub>) - k"<sub><em>f</em></sub> X<sub>t</sub> (CI<sub>t</sub> - CI<sub>c</sub>) + T<sub><em>f</em></sub> (CI<sub>t</sub> - CI<sub>c</sub>) + M<sub>c</sub>
</blockquote>
</p>

<div class="well">
  <form class="form-inline">
    <label>
      <div>
        <h5>Select color index</h5>
      </div>
      <div>
        <div id="select-color-index-success" class="alert alert-success" style="display:none">
          Color index successfully updated.
        </div>
        <div id="select-color-index-success" class="alert alert-danger" style="display:none">
          Something went wrong - failed to update your setting.
        </div>
        <select id="select-color-index-1" class="form-control">
          {% for filter in image_filters %}
            <option value="{{filter.band}}" {% if filter.band == reduction.data.color_index_1_band %}selected{% endif %}>
              {{filter.band}} ({{filter.system}})
            </option>
          {% endfor %}
        </select>
        -
        <select id="select-color-index-2" class="form-control">
          {% for filter in image_filters %}
            <option value="{{filter.band}}" {% if filter.band == reduction.data.color_index_2_band %}selected{% endif %}>
              {{filter.band}} ({{filter.system}})
            </option>
          {% endfor %}
        </select>
      </div>
    </label>
  </form>
</div>

<div style="margin-bottom:1em">
  <a href="#" class="btn btn-primary js-run-reductions">Re-run reductions</a>
</div>

<h4>Step 1: Compute transform coefficient T<sub><em>f</em></sub></h4>
<p>
T<sub><em>f</em></sub> is a coefficient that converts your raw instrumental magnitude to a standard magnitude in color band <em>f</em>. It is solved for by the following equation:
</p>
<p>
<blockquote>
  M<sub><em>f</em></sub> - m<sub><em>f</em></sub> = T<sub><em>f</em></sub> CI + ZP<sub><em>f</em></sub>
</blockquote>
</p>
<p>
In which:<br>
M<sub><em>f</em></sub> = standard magnitude in color band of filter <em>f</em><br>
m<sub><em>f</em></sub> = raw instrumental magnitude in color band of filter <em>f</em><br>
T<sub><em>f</em></sub> = coefficient that converts raw instrumental magnitude to standard magnitude in color band <em>f</em><br>
CI = standard color index<br>
ZP<sub><em>f</em></sub> = nightly zero point for the color band of filter <em>f</em>, at the airmass of the reference field.
</p>

<div class="well">
Slope = t<sub><em>f</em></sub> = {{reduction.data.tf}}
<img src="{{reduction.urls.tf_graph}}">
</div>

<h4>Step 2: Compute second-order extinction k"<sub><em>f</em></sub></h4>
<div class="well">
  <div id="second-order-extinction-success" class="alert alert-success" style="display:none">
    k'' successfully updated.
  </div>
  <div id="second-order-extinction-success" class="alert alert-danger" style="display:none">
    Something went wrong - failed to update your setting.
  </div>
  <input type="text" class="form-control" id="second-order-extinction" value="{{reduction.data.second_order_extinction}}" />
</div>

<h4>Step 3: Compute airmass X<sub>t</sub></h4>

<div class="well">
  <p>
    Using date <strong>{{result.meta.datetime | date:'c'}}</strong> and altitude <strong>{{result.meta.elevation}} meters</strong>.
  </p>
  <table class="table table-striped table-hover">
    <tr>
      <th>Designation</th>
      <th>RA (obs)</th>
      <th>Dec (obs)</th>
      <th>Airmass</th>
    </tr>
    {% for star in reduction.data.reduced_stars %}
      <tr>
        <td>
          <a target="_blank" href="http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-ref=VIZ592c985c22af&-out.add=.&-source=I/329&-c={{star.index_ra}},{{star.index_dec}},eq=J2000,rs=0.002">{{star.designation}}</a>
        </td>
        <td>{{star.index_ra}}</td>
        <td>{{star.index_dec}}</td>
        <td><strong>{{star.airmass}}</strong></td>
      </tr>
    {% endfor %}
  </table>
</div>

<h4>Step 4: Apply the formula to get M<sub><em>t</em></sub></h4>

<div class="well">
  <p>
    Given the formula:
    <blockquote>
    M<sub>t</sub> = (m<sub>t</sub> - m<sub>c</sub>) - k"<sub><em>f</em></sub> X<sub>t</sub> (CI<sub>t</sub> - CI<sub>c</sub>) + T<sub><em>f</em></sub> (CI<sub>t</sub> - CI<sub>c</sub>) + M<sub>c</sub>
    </blockquote>
  </p>
  <p>
    All magnitudes are in band {{result.meta.image_band}}.
  </p>
  <table class="table table-striped table-hover">
    <tr>
      <th>Designation</th>
      <th>RA (obs)</th>
      <th>Dec (obs)</th>
      <th>Standard Mag</th>
      <th>Catalog Mag</th>
      <th>Diff</th>
    </tr>
    {% for star in reduction.data.reduced_stars %}
      <tr>
        <td>
          <a target="_blank" href="http://vizier.u-strasbg.fr/viz-bin/VizieR-5?-ref=VIZ592c985c22af&-out.add=.&-source=I/329&-c={{star.index_ra}},{{star.index_dec}},eq=J2000,rs=0.002">{{star.designation}}</a>
        </td>
        <td>{{star.index_ra}}</td>
        <td>{{star.index_dec}}</td>
        <td><strong>{{star.mag_standard}}</strong></td>
        <td><strong>{{star.mag_catalog}}</strong></td>
        <td><strong>{{star.mag_error}}</strong></td>
      </tr>
    {% endfor %}
  </table>
</div>

<div style="text-align: right">
  <a href="javascript:window.history.back()" class="btn btn-lg btn-default">Back</a>
  <a href="#" class="btn btn-lg btn-default js-run-reductions">Re-run Reductions</a>
  <a href="/submission/reduction/{{result.subid}}" class="btn btn-primary">Review</a>
</div>
{% endblock %}
{% block scripts %}
  <script>
    window.subid = {{result.subid | jsonify }};
    window.originalImageUrl = {{result.urls.original_display_url | jsonify}};
    window.catalogReferenceStars = {{ result.data.catalog_reference_stars | jsonify }};
  </script>
  <script src="{% static "imageflow/js/submission_util.js" %}" type="text/javascript"></script>
  <script src="{% static "imageflow/js/submission_reduction.js" %}" type="text/javascript"></script>
{% endblock %}
