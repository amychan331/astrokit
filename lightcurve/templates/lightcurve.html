{% extends 'layout-internal.html' %}
{% load staticfiles %}
{% load jsonify %}

{% block title %}Light Curve {{lightcurve.name}} - Overview{% endblock %}

{% block styles %}
<style>
h1 span {
  color:#286090;
}

.checklist {
  position: fixed;
}

.user-image {
  max-width: 300px;
  max-height: 300px;
}

.image-container {
  margin: 2em 0;
}

.col-md-12, .col-md-8 {
  padding-left: 0;
}

.iframe-target {
  width: 100%;
  height: 60em;

  border: none;
}
</style>
{% endblock %}

{% block heading %}
  <form class="js-edit-name-form" data-lightcurve-id={{lightcurve.id}} method="post">
    Light Curve
    <span class="lightcurve-name">{{lightcurve.name}}</span>
    {% if user == lightcurve.user %}
    <input type="name" class="lightcurve-name" name="lightcurve_name" style="display:none" value="{{lightcurve.name}}">
    <button type="button" class="btn btn-xs btn-default js-edit-name" style="display:inline-block">Edit Name</button>
    <button type="submit" class="btn btn-sm btn-primary js-submit-name" style="display:none">Save</button>
    <button type="button" class="btn btn-sm btn-default js-cancel" style="display:none">Cancel</button>
    <a href="{% url "upload_image" %}/{{lightcurve.id}}" class="btn btn-primary pull-right">Add New Images</a>
    {% endif %}
  </form>
{% endblock %}

{% block content-interior %}
<div class="col-md-12">
  <a href="plot" class="btn btn-default">Standard Magnitudes Plot</a>
  <a href="plot?type=instrumental" class="btn btn-default">Instrumental Magnitudes Plot</a>
  <a href="#" class="btn btn-default">Download as XLSX</a>
  <a href="#" class="btn btn-default">Download as ALCDEF</a>
</div>

<div class="col-md-8">
  <h2 id="settings">Settings</h2>
  <p>These settings apply to all images.  You can change these values for individual images later.</p>
  <div>
    <h4>Target</h4>
    <div class="well">
      Name (<a href="https://ssd.jpl.nasa.gov/horizons.cgi">JPL Horizons</a>) <input type="text" class="form-control" style="width:20em" id="target-name" value="{{analysis.meta.target_name}}" />
    </div>

    <h4>Coordinates</h4>
    <div class="well">
      Latitude <input id="set-latitude" class="form-control" style="width: 20em" type="number" value="{{result.meta.latitude}}" min="-90" max="90">
      <br>
      Longitude <input id="set-longitude" class="form-control" style="width: 20em" type="number" value="{{result.meta.longitude}}" min="-180" max="180">
    </div>

    <h4>Elevation</h4>
    <div class="well">
      Above sea level (meters)
      <input id="set-elevation" class="form-control" style="width: 20em" type="number" value="{{result.meta.elevation}}">
    </div>

    <h4>Second-order extinction k"<sub><em>f</em></sub></h4>
    <div class="well">
      <p>
        Second-order extinction is nearly constant and usually only significant for B-V color index measurements. Set to 0 if you do not want to include a term for second-order extinction.
      </p>
      <input type="text" class="form-control" style="width:20em" id="second-order-extinction" value="{{reduction.data.second_order_extinction}}" placeholder="0.0" />
    </div>

    <div class="button-row">
      <div id="save-observation-default" class="btn btn-primary">Apply settings</div>
    </div>
  </div>

  <hr/>

  <h2 id="select-targets">Targets</h2>
  <div>
    <iframe class="iframe-target" src="/analysis/select_target_modal/{{images.0.analysis.id}}"></iframe>
  </div>

  <hr/>

  <h2 id="select-pairs">Image Pairs</h2>
  <p>
    Select images in different color bands to compute color index and hidden transform. Select "None" to omit transforms for your reductions.
  </p>
  <div>
    {% include 'partials/image_pair_selector.html' %}
  </div>
  <div class="button-row">
    <div class="btn btn-primary js-save-image-pairs">Save image pairs</div>
  </div>

  <hr/>

  <h2 id="calculations">Calculations</h2>
  <p>
    CI/Hidden transform
  </p>

  <hr/>

  <h2 id="review-analyses">Review each image</h2>
  <p>
    For color index/hidden transform.
  </p>
  {% for image in images %}
  <div id="image-{{forloop.counter0}}" class="well">
    <strong><a href="/analysis/{{image.analysis.id}}">Analysis #{{image.analysis.id}}</a></strong><br>
    Filename:
    <a download href="{{image.image_url}}">
      {{image.original_filename}}
    </a><br>
    Timestamp: {{image.analysis.image_datetime}}<br>

    Status:
    {% if image.analysis %}
      {% if image.analysis.status == 'ASTROMETRY_PENDING'  %}
        <span style="color:#ff1493"><strong>Stage 1 - Astrometry: performing analysis</strong></span>
      {% elif image.analysis.status == 'PHOTOMETRY_PENDING'  %}
        <span style="color:#ff1493"><strong>Stage 2 - Photometry: performing analysis</strong></span>
      {% elif image.analysis.status == 'REVIEW_PENDING'  %}
        <span style="color:#ff1493"><strong>Stage 3 - Review: analysis complete, review pending</strong></span>
      {% elif image.analysis.status == 'REVIEW_COMPLETE'  %}
        <span style="color:#215022"><strong>Stage 4 - Reduction: analysis reviewed, reduction pending</strong></span>
      {% elif image.analysis.status == 'REDUCTION_COMPLETE'  %}
        <span style="color:#215022"><strong>Stage 4 - Reduction: complete</strong></span>
      {% elif image.analysis.status == 'ADDED_TO_LIGHT_CURVE'  %}
        <span style="color:#215022"><strong>Stage 5 - Added to light curve</strong></span>
      {% endif %}
    {% elif image.submission %}
      {% if image.submission.status == 'FAILED_TO_SUBMIT' %}
        <span style="color:red"><strong>Stage 1 - Astrometry: service failed, try upload image again</strong></span>
      {% elif image.submission.status == 'FAILED_TO_PROCESS' %}
        <span style="color:red"><strong>Stage 1 - Astrometry: failed to solve image</strong></span>
      {% elif image.submission.status == 'SUBMITTED' %}
        <span style="color:#ff1493">Stage 1 - Astrometry: solving</span>
      {% endif %}
    {% else %}
      <span style="color:purple">Stage 0: Uploaded, astrometry starting...</span>
    {% endif %}

    {% if image.analysis.notes %}
        <br>Note: <em>{{image.analysis.notes}}</em>
    {% endif %}

    <div class="image-container">
      {% if image.analysis.original_display_url %}
        <a href="/analysis/{{image.analysis.id}}">
          <img src="{{image.analysis.original_display_url}}" class="user-image" />
        </a>
      {% endif %}
    </div>

    <div class="button-row">
      {% if image.submission and image.submission.status == 'COMPLETE' %}
        <a href="/analysis/{{image.analysis.id}}" class="btn btn-primary">Review Analysis</a>
      {% elif image.submission %}
        <a href="/analysis/{{image.analysis.id}}" class="btn btn-primary disabled">Analysis Pending</a>
      {% endif %}

      {% if image.analysis.target_id %}
        <div class="btn btn-default js-select-target" data-analysis-id="{{image.analysis.id}}">Change Target</div>
      {% else %}
        <div class="btn btn-primary js-select-target" data-analysis-id="{{image.analysis.id}}">Select Target</div>
      {% endif %}

      {% if image.analysis and image.analysis.status == 'REDUCTION_COMPLETE' %}
        <div class="btn btn-success js-toggle-lightcurve" data-analysis-id="{{image.analysis.id}}">Add to lightcurve</div>
      {% elif image.analysis and image.analysis.status == 'ADDED_TO_LIGHT_CURVE' %}
        <div class="btn btn-warning js-toggle-lightcurve" data-analysis-id="{{image.analysis.id}}">Remove from lightcurve</div>
      {% endif %}
      {% if image.submission %}
        <a href="http://35.202.61.141/status/{{image.analysis.astrometry_job.jobid}}" class="btn btn-default">View Astrometry job</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
  <div>
    <p>
      <button style="display:none" class="btn btn-success js-reload js-new-results">Load new results</button>
    </p>
  </div>
</div>
<div class="col-md-4">
  <div class="checklist">
    <h2>Checklist</h2>
    <p>
      ☐ <a href="#settings">Set global settings</a><br>
      ☑ Initial processing of astrometry and photometry (<span id="num-images-processed">0</span> of {{ images | length }})<br>
      ☐ <a href="#first-pass-selection">Select targets</a> (<span id="num-images-target">?</span> of {{ images | length }})<br>
      ☐ <a href="#select-pairs">Select image pairs</a> (<span id="num-images-companion">?</span> selected)<br>
      ☐ Confirm CI/transform calculations<br>
      ☐ <a href="#review-analyses">Review analyses</a> (<span id="num-images-reviewed">?</span> of {{ images | length}})<br>
      ☐ Add to light curve (<span id="num-images-lightcurve">?</span> of {{ images | length}})<br>
    </p>
    <p>
      <button style="display:none" class="btn btn-success js-reload js-new-results">Load new results</button>
    </p>
  </div>
</div>

<div class="iframe-modal">
  {% include 'partials/modal.html' %}
</div>

<div class="select-image-modal">
  <div class="modal fade">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Select Image</h4>
        </div>
        <div class="modal-body">
          <div class="table-wrapper">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th></th>
                  <th>Analysis ID</th>
                  <th>Filter</th>
                  <th>Filename</th>
                  <th>Target ID</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <input type="radio" name="image-radio" value="NONE" />
                  </td>
                  <td>None</td>
                  <td>-</td>
                  <td>None</td>
                  <td>-</td>
                </tr>
                {% for image in images %}
                  {% if reduction.meta.image_companion_id == image.id %}
                    <tr class="highlight">
                  {% elif image.analysis.target_id %}
                    <tr style="background-color: #e5ffe0">
                  {% else %}
                    <tr>
                  {% endif %}
                    <td>
                      {% if image.analysis.target_id %}
                        <input type="radio" name="image-radio" value="{{image.analysis.id}}" />
                      {% endif %}
                    </td>
                    <td><a href="/analysis/{{image.analysis.id}}">{{image.analysis.id}}</a></td>
                    <td>{{image.analysis.image_filter.band}}</td>
                    <td><a href="/analysis/{{image.analysis.id}}">{{image.original_filename | truncatechars:40}}</a></td>
                    <td>
                      {% if image.analysis.target_id %}
                        {{image.analysis.target_id}}
                      {% else %}
                        <span style="color:red">No target</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary js-select-image-update" data-dismiss="modal">Done</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
</div>

{% endblock %}

{% csrf_token %}

{% block scripts %}
  <script>
    window.lightcurveId = {{lightcurve.id | jsonify}};
  </script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="{% static "imageflow/js/csrf.js" %}" type="text/javascript"></script>
  <script src="{% static "imageflow/js/util.js" %}" type="text/javascript"></script>
  <script src="{% static "lightcurve/js/lightcurve.js" %}" type="text/javascript"></script>
{% endblock %}
