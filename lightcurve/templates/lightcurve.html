{% extends 'layout-internal.html' %}
{% load staticfiles %}

{% block styles %}
<style>
h1 span {
  color:#286090;
}

.user-image {
  max-width: 300px;
  max-height: 300px;
}

.image-container {
  margin: 2em 0;
}
</style>
{% endblock %}

{% block content-interior %}
<h1>Light Curve <span>{{lightcurve.name}}</span></h1>
<div>
  <p>
    <span id="num-images-processed">0</span> of {{ images | length }} images have been processed.
  </p>
  <p>
    <button style="display:none" class="btn btn-success js-reload js-new-results">Load new results</button>
  </p>
  {% for image in images %}
  <div id="image-{{forloop.counter0}}" class="well">
    Filename:
    <a download href="{{image.image_url}}">
      {{image.original_filename}}
    </a><br>
    Uploaded: {{image.created_at}}<br>

    Status:
    {% if image.analysis %}
      {% if image.analysis.status == 'PENDING'  %}
        <span style="color:pink"><strong>Stage 1 - Astrometry: receiving analysis</strong></span>
      {% elif image.analysis.status == 'REVIEW_PENDING'  %}
        <span style="color:pink"><strong>Stage 1 - Astrometry: analysis completed, review pending</strong></span>
      {% elif image.analysis.status == 'REVIEW_COMPLETE'  %}
        <span style="color:dark green"><strong>Stage 2 - Reduction: astrometry review completed, run reduction</strong></span>
      {% elif image.analysis.status == 'REDUCTION_COMPLETE'  %}
        <span style="color:dark green"><strong>Stage 2 - Reduction: completed, add to light curve</strong></span>
      {% elif image.analysis.status == 'ADDED_TO_LIGHTCURVE'  %}
        <span style="color:blue"><strong>Stage 3 - Light curve: select and add point</strong></span>
      {% endif %}
    {% elif image.submission %}
      {% if image.submission.status == 'FAILED_TO_SUBMIT' %}
        <span style="color:red"><strong>Stage 1 - Astrometry: service failed, try upload image again</strong></span>
      {% elif image.submission.status == 'FAILED_TO_PROCESS' %}
        <span style="color:red"><strong>Stage 1 - Astrometry: failed to solve image</strong></span>
      {% elif image.submission.status == 'SUBMITTED' %}
        <span style="color:pink">Stage 1 - Astrometry: solving</span>
      {% endif %}
    {% else %}
      <span style="color:purple">Uploaded, astrometry stage starting...</span>
    {% endif %}

    <div class="image-container">
      {% if image.analysis.original_display_url %}
        <a href="{{image.analysis.original_display_url}}">
          <img src="{{image.analysis.original_display_url}}" class="user-image" />
        </a>
      {% endif %}
    </div>

    <div class="button-row">
      {% if image.submission and image.submission.status == 'COMPLETE' %}
        <a href="/submission/{{image.submission.subid}}" class="btn btn-primary">Review Analysis</a>
      {% elif image.submission %}
        <a href="/submission/{{image.submission.subid}}" class="btn btn-primary disabled">Analysis Pending</a>
      {% endif %}
      {% if image.submission %}
        <a href="http://35.202.61.141/status/{{image.submission.subid}}" class="btn btn-default">View Astrometry job</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
  <div>
    <p>
      <button style="display:none" class="btn btn-success js-reload js-new-results">Load new results</button>
    </p>
  </div>
</div>
{% endblock %}

{% csrf_token %}

{% block scripts %}
  <script>
    window.lightcurve_id = {{lightcurve.id}};
  </script>
  <script src="{% static "imageflow/js/submission_util.js" %}" type="text/javascript"></script>
  <script src="{% static "lightcurve/js/lightcurve.js" %}" type="text/javascript"></script>
{% endblock %}
